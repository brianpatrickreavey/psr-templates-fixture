name: PSR Template Test Harness

on:
  repository_dispatch:
    types: [test-harness-run]

permissions:
  contents: write

concurrency:
  group: psr-test-harness-${{ github.repository }}
  cancel-in-progress: false

jobs:
  pre-psr-tests:
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
      - name: Pre-cleanup tags, releases, and branches
        uses: ./.github/actions/cleanup-tags-releases
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Create test branch
        uses: ./.github/actions/create-test-branch
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies-base
      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests
      - name: Generate test commits
        uses: ./.github/actions/run-generate-commits
      - name: Configure git and push
        uses: ./.github/actions/configure-git-push
        with:
          run_id: ${{ github.event.client_payload.run_id }}

  psr-execution:
    needs: pre-psr-tests
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr.outputs.tag }}
      version: ${{ steps.psr.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Install arranger
        run: |
          source /tmp/venv/bin/activate
          uv pip install git+https://github.com/brianpatrickreavey/psr-templates.git
      - name: Run arranger
        run: |
          source /tmp/venv/bin/activate
          python -m arranger.run
      - name: Debug - List files before PSR
        run: |
          echo "=== Current directory: $(pwd) ==="
          echo "=== Files in repo root ==="
          ls -lhR .
          echo "=== Search for addon.xml files ==="
          find . -name "addon.xml*" -type f -exec ls -lh {} \;
          echo "=== Templates directory contents ==="
          ls -lh templates/ || echo "No templates directory"
      - name: Run PSR
        id: psr
        continue-on-error: true
        uses: python-semantic-release/python-semantic-release@v10.5.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit: true
          push: true
          tag: true
          vcs_release: true
      - name: Debug - List files after PSR
        run: |
          echo "=== Current directory: $(pwd) ==="
          echo "=== Files in repo root after PSR ==="
          ls -lhR .
          echo "=== Search for addon.xml files after PSR ==="
          find . -name "addon.xml*" -type f -exec ls -lh {} \;
          echo "=== Templates directory contents after PSR ==="
          ls -lh templates/ || echo "No templates directory"
          echo "=== Check if addon.xml was updated ==="
          cat script.module.example/addon.xml | grep -E "version|name" || echo "Could not read addon.xml"

  kodi-check:
    needs: psr-execution
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project and set env vars
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip:
    needs: [psr-execution, kodi-check]
    if: needs.kodi-check.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP
        run: |
          mkdir -p artifacts
          zip -r artifacts/${{ needs.kodi-check.outputs.kodi_project_name }}-${{ needs.psr-execution.outputs.version }}.zip ${{ needs.kodi-check.outputs.kodi_directory }}
      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: kodi-addon-zip
          path: artifacts/${{ needs.kodi-check.outputs.kodi_project_name }}-${{ needs.psr-execution.outputs.version }}.zip

  kodi-publish:
    needs: [psr-execution, kodi-check, kodi-zip]
    if: needs.kodi-check.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Download ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: kodi-addon-zip
      - name: Upload ZIP to release
        run: |
          gh release upload ${{ needs.psr-execution.outputs.tag }} artifacts/${{ needs.kodi-check.outputs.kodi_project_name }}-${{ needs.psr-execution.outputs.version }}.zip --clobber

  pre-cleanup-check:
    needs: [psr-execution, kodi-check, kodi-zip, kodi-publish]
    runs-on: ubuntu-latest
    steps:
      - name: List tags
        run: |
          gh api repos/${{ github.repository }}/git/refs/tags --jq '.[] | .ref' || echo "No tags found"
      - name: List releases
        run: |
          gh api repos/${{ github.repository }}/releases --jq '.[] | {tag: .tag_name, assets: (.assets | length)}' || echo "No releases found"
      - name: List artifacts on releases
        run: |
          gh api repos/${{ github.repository }}/releases --jq '.[] | select(.assets != []) | {release: .tag_name, assets: [.assets[].name]}' || echo "No release assets found"
      - name: Sleep for inspection
        run: sleep 1 # Add more time as needed

  post-psr-tests:
    needs: [psr-execution, kodi-check, kodi-zip, kodi-publish]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: 1
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Switch to test branch
        run: |
          git checkout ci/${{ github.event.client_payload.run_id }} || git checkout -b ci/${{ github.event.client_payload.run_id }}
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies-full
      - name: Run post-PSR integration tests
        uses: ./.github/actions/run-post-psr-tests

  cleanup:
    needs: [pre-psr-tests, psr-execution, kodi-check, kodi-zip, kodi-publish, pre-cleanup-check, post-psr-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4

      - name: Clean up test branch
        run: |
          git checkout main
          git branch -D ci/${{ github.event.client_payload.run_id }} || true

      - name: Clean up tags, releases, and branches
        uses: ./.github/actions/cleanup-tags-releases

      - name: Dispatch results back to templates repo
        run: |
          STATUS="success"
          if [ "${{ needs.pre-psr-tests.result }}" != "success" ] || [ "${{ needs.psr-execution.result }}" != "success" ] || [ "${{ needs.post-psr-tests.result }}" != "success" ]; then
            STATUS="failure"
          fi
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.event.client_payload.templates_repo }}/dispatches \
            -d '{
              "event_type": "test-harness-complete",
              "client_payload": {
                "run_id": "${{ github.event.client_payload.run_id }}",
                "status": "'$STATUS'",
                "psr_version": "v10.5.3"
              }
            }'