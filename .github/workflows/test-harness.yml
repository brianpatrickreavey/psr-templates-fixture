name: PSR Template Test Harness

on:
  repository_dispatch:
    types: [test-harness-run]

permissions:
  contents: write

concurrency:
  group: psr-test-harness-${{ github.repository }}
  cancel-in-progress: false

jobs:
  pre-release-tests:
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
      - name: Pre-cleanup tags, releases, and branches
        uses: ./.github/actions/cleanup-tags-releases
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Create test branch
        uses: ./.github/actions/create-test-branch
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies
      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests

  release-phase-1:
    needs: pre-release-tests
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_1.outputs.tag }}
      version: ${{ steps.psr_1.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Setup development environment
        uses: ./.github/actions/setup-dev-environment
      - name: Generate and push phase 1 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '1'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 1)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 0.1.0)
        id: psr_1
        uses: ./.github/actions/run-psr
        with:
          mode: github
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload CHANGELOG to v0.1.0 release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.psr_1.outputs.tag }} CHANGELOG.md --clobber
        if: steps.psr_1.outputs.tag

  release-phase-2:
    needs: [kodi-publish-1]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_2.outputs.tag }}
      version: ${{ steps.psr_2.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0  # Full history to see v0.1.0
      - name: Setup development environment
        uses: ./.github/actions/setup-dev-environment
      - name: Generate and push phase 2 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '2'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 2)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 0.2.0)
        id: psr_2
        uses: ./.github/actions/run-psr
        with:
          mode: github
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload CHANGELOG to v0.2.0 release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.psr_2.outputs.tag }} CHANGELOG.md --clobber
        if: steps.psr_2.outputs.tag

  release-phase-3:
    needs: [kodi-publish-2]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_3.outputs.tag }}
      version: ${{ steps.psr_3.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0  # Full history to see v0.1.0 and v0.2.0
      - name: Setup development environment
        uses: ./.github/actions/setup-dev-environment
      - name: Generate and push phase 3 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '3'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 3)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.0 - force major)
        id: psr_3
        uses: ./.github/actions/run-psr
        with:
          mode: github
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: major
      - name: Upload CHANGELOG to v1.0.0 release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.psr_3.outputs.tag }} CHANGELOG.md --clobber
        if: steps.psr_3.outputs.tag

  kodi-check-1:
    needs: release-phase-1
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project (Phase 1)
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip-1:
    needs: [release-phase-1, kodi-check-1]
    if: needs.kodi-check-1.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP (Phase 1 - v0.1.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-1.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-1.outputs.kodi_directory }}
          version: ${{ needs.release-phase-1.outputs.version }}
          phase: 'phase-1'

  kodi-publish-1:
    needs: [release-phase-1, kodi-check-1, kodi-zip-1]
    if: needs.kodi-check-1.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Publish Kodi ZIP (Phase 1 - v0.1.0)
        uses: ./.github/actions/publish-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-1.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-1.outputs.version }}
          tag: ${{ needs.release-phase-1.outputs.tag }}
          phase: 'phase-1'

  kodi-check-2:
    needs: [kodi-publish-1, release-phase-2]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project (Phase 2)
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip-2:
    needs: [release-phase-2, kodi-check-2]
    if: needs.kodi-check-2.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP (Phase 2 - v0.2.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-2.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-2.outputs.kodi_directory }}
          version: ${{ needs.release-phase-2.outputs.version }}
          phase: 'phase-2'

  kodi-publish-2:
    needs: [release-phase-2, kodi-check-2, kodi-zip-2]
    if: needs.kodi-check-2.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Publish Kodi ZIP (Phase 2 - v0.2.0)
        uses: ./.github/actions/publish-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-2.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-2.outputs.version }}
          tag: ${{ needs.release-phase-2.outputs.tag }}
          phase: 'phase-2'

  kodi-check-3:
    needs: [kodi-publish-2, release-phase-3]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project (Phase 3)
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip-3:
    needs: [release-phase-3, kodi-check-3]
    if: needs.kodi-check-3.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP (Phase 3 - v1.0.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-3.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-3.outputs.kodi_directory }}
          version: ${{ needs.release-phase-3.outputs.version }}
          phase: 'phase-3'

  kodi-publish-3:
    needs: [release-phase-3, kodi-check-3, kodi-zip-3]
    if: needs.kodi-check-3.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Publish Kodi ZIP (Phase 3 - v1.0.0)
        uses: ./.github/actions/publish-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-3.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-3.outputs.version }}
          tag: ${{ needs.release-phase-3.outputs.tag }}
          phase: 'phase-3'

  release-phase-4:
    needs: [kodi-publish-3]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_4.outputs.tag }}
      version: ${{ steps.psr_4.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Setup development environment
        uses: ./.github/actions/setup-dev-environment
      - name: Generate and push phase 4 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '4'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 4)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.0 - docs only)
        id: psr_4
        uses: ./.github/actions/run-psr
        with:
          mode: github
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload CHANGELOG to v1.0.0 release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.psr_4.outputs.tag }} CHANGELOG.md --clobber
        if: steps.psr_4.outputs.tag

  release-phase-5:
    needs: [kodi-publish-4]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_5.outputs.tag }}
      version: ${{ steps.psr_5.outputs.version }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Setup development environment
        uses: ./.github/actions/setup-dev-environment
      - name: Generate and push phase 5 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '5'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 5)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.1)
        id: psr_5
        uses: ./.github/actions/run-psr
        with:
          mode: github
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload CHANGELOG to v1.0.1 release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.psr_5.outputs.tag }} CHANGELOG.md --clobber
        if: steps.psr_5.outputs.tag

  kodi-check-4:
    needs: [kodi-publish-3, release-phase-4]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project (Phase 4)
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip-4:
    needs: [release-phase-4, kodi-check-4]
    if: needs.kodi-check-4.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP (Phase 4 - v1.0.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-4.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-4.outputs.kodi_directory }}
          version: ${{ needs.release-phase-4.outputs.version }}
          phase: 'phase-4'

  kodi-publish-4:
    needs: [release-phase-4, kodi-check-4, kodi-zip-4]
    if: needs.kodi-check-4.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Publish Kodi ZIP (Phase 4 - v1.0.0)
        uses: ./.github/actions/publish-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-4.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-4.outputs.version }}
          tag: ${{ needs.release-phase-4.outputs.tag }}
          phase: 'phase-4'

  kodi-check-5:
    needs: [kodi-publish-4, release-phase-5]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project (Phase 5)
        id: check
        uses: ./.github/actions/check-kodi-project

  kodi-zip-5:
    needs: [release-phase-5, kodi-check-5]
    if: needs.kodi-check-5.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Build Kodi addon ZIP (Phase 5 - v1.0.1)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-5.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-5.outputs.kodi_directory }}
          version: ${{ needs.release-phase-5.outputs.version }}
          phase: 'phase-5'

  kodi-publish-5:
    needs: [release-phase-5, kodi-check-5, kodi-zip-5]
    if: needs.kodi-check-5.outputs.is_kodi == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Publish Kodi ZIP (Phase 5 - v1.0.1)
        uses: ./.github/actions/publish-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-5.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-5.outputs.version }}
          tag: ${{ needs.release-phase-5.outputs.tag }}
          phase: 'phase-5'

  post-release-tests:
    needs: [kodi-publish-5]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: 1
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Switch to test branch
        run: |
          git checkout ci/${{ github.event.client_payload.run_id }} || git checkout -b ci/${{ github.event.client_payload.run_id }}
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies
      - name: Run post-PSR integration tests
        uses: ./.github/actions/run-post-psr-tests