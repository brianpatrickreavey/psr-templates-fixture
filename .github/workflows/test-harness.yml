name: PSR Template Test Harness (Consolidated with Make)

on:
  repository_dispatch:
    types: [test-harness-run]

jobs:
  pre-psr-tests:
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$PATH:/root/.local/bin"
          uv venv /tmp/venv
          export UV_VENV=/tmp/venv

      - name: Create test branch
        run: |
          git checkout -b ci/${{ github.event.client_payload.run_id }}

      - name: Checkout templates repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.templates_repo }}
          ref: ${{ github.event.client_payload.templates_ref }}
          path: templates

      - name: Install dev dependencies
        run: |
          source /tmp/venv/bin/activate
          cd templates
          uv sync --group dev

      - name: Run pre-PSR integration tests
        run: |
          source /tmp/venv/bin/activate
          cd templates
          PYTHONPATH=. pytest tests/integration/pre_psr/ -v

  psr-execution:
    needs: pre-psr-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4

      - name: Switch to test branch
        run: |
          git checkout ci/${{ github.event.client_payload.run_id }}

      - name: Checkout templates repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.templates_repo }}
          ref: ${{ github.event.client_payload.templates_ref }}
          path: templates

      - name: Run arranger
        run: |
          python templates/arranger/run.py --templates-dir templates

      - name: Generate test commits
        run: |
          python templates/tools/generate_commits.py .

      - name: Show git log
        run: |
          git log --oneline

      - name: Run PSR
        continue-on-error: true
        uses: python-semantic-release/python-semantic-release@v10.5.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit: false
          push: false
          tag: true
          vcs_release: true
          no_operation_mode: false

  post-psr-tests:
    needs: psr-execution
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: false
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4

      - name: Switch to test branch
        run: |
          git checkout ci/${{ github.event.client_payload.run_id }}

      - name: Checkout templates repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.templates_repo }}
          ref: ${{ github.event.client_payload.templates_ref }}
          path: templates

      - name: Install dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$PATH:/root/.local/bin"
          uv venv /tmp/venv
          export UV_VENV=/tmp/venv

      - name: Install dev dependencies
        run: |
          source /tmp/venv/bin/activate
          cd templates
          uv sync --group dev

      - name: Run post-PSR integration tests
        run: |
          source /tmp/venv/bin/activate
          cd templates
          PYTHONPATH=. pytest tests/integration/post_psr/ -v

  cleanup:
    needs: [pre-psr-tests, psr-execution, post-psr-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4

      - name: Clean up test branch
        run: |
          git checkout main
          git branch -D ci/${{ github.event.client_payload.run_id }} || true

      - name: Clean up test tags
        run: |
          git tag -l "v*" | xargs -r git tag -d || true

      - name: Dispatch results back to templates repo
        run: |
          STATUS="success"
          if [ "${{ needs.pre-psr-tests.result }}" != "success" ] || [ "${{ needs.psr-execution.result }}" != "success" ] || [ "${{ needs.post-psr-tests.result }}" != "success" ]; then
            STATUS="failure"
          fi
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.event.client_payload.templates_repo }}/dispatches \
            -d '{
              "event_type": "test-harness-complete",
              "client_payload": {
                "run_id": "${{ github.event.client_payload.run_id }}",
                "status": "'$STATUS'",
                "psr_version": "v10.5.3"
              }
            }'