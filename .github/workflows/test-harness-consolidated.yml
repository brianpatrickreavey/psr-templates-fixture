name: PSR Template Test Harness (Consolidated)

on:
  repository_dispatch:
    types: [test-harness-run]

permissions:
  contents: write

concurrency:
  group: psr-test-harness-${{ github.repository }}
  cancel-in-progress: false

jobs:
  pre-release-tests:
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.act && 'brianpatrickreavey/psr-templates-fixture' || github.repository }}

      - name: Pre-cleanup (GitHub mode)
        if: ${{ !github.event.act }}
        uses: ./.github/actions/cleanup-tags-releases

      - name: Pre-cleanup (ACT mode)
        if: ${{ github.event.act }}
        run: git tag -d $(git tag) 2>/dev/null || true

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Create test branch
        uses: ./.github/actions/create-test-branch

      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests

  # Phase 1: v0.1.0
  release-phase-1:
    needs: pre-release-tests
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_1.outputs.tag }}
      version: ${{ steps.psr_1.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Generate commits (Phase 1)
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '1'
          branch: ci/${{ github.event.client_payload.run_id }}

      - name: Run psr_prepare (Phase 1)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare

      - name: Run PSR (Phase 1)
        id: psr_1
        uses: ./.github/actions/run-psr
        with:
          mode: ${{ github.event.act && 'act' || 'github' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CHANGELOG (GitHub only)
        if: ${{ !github.event.act && steps.psr_1.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.psr_1.outputs.tag }} CHANGELOG.md --clobber

  # Kodi jobs for Phase 1 (GitHub only)
  kodi-check-1:
    needs: release-phase-1
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - name: Check for Kodi project
        id: check
        uses: ./.github/actions/consolidated-kodi-check

  kodi-zip-1:
    needs: [release-phase-1, kodi-check-1]
    if: ${{ needs.kodi-check-1.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-1.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-1.outputs.kodi_directory }}
          version: ${{ needs.release-phase-1.outputs.version }}
          phase: 'phase-1'

  kodi-publish-1:
    needs: [release-phase-1, kodi-check-1, kodi-zip-1]
    if: ${{ needs.kodi-check-1.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-publish
        with:
          kodi_project_name: ${{ needs.kodi-check-1.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-1.outputs.version }}
          tag: ${{ needs.release-phase-1.outputs.tag }}
          phase: 'phase-1'

  # Phase 2: v0.2.0
  release-phase-2:
    needs: [kodi-publish-1]
    if: always() && needs.kodi-publish-1.result == 'success'
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_2.outputs.tag }}
      version: ${{ steps.psr_2.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Generate commits (Phase 2)
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '2'
          branch: ci/${{ github.event.client_payload.run_id }}

      - name: Debug addon.xml (ACT only)
        if: ${{ github.event.act }}
        run: |
          echo "=== addon.xml before Phase 2 psr_prepare ===" && cat script.module.example/addon.xml
          echo "" && echo "=== File check ===" && wc -c script.module.example/addon.xml && file script.module.example/addon.xml
          echo "" && echo "=== Bytes ===" && head -c 10 script.module.example/addon.xml | od -c
        continue-on-error: true

      - name: Run psr_prepare (Phase 2)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare

      - name: Run PSR (Phase 2)
        id: psr_2
        uses: ./.github/actions/run-psr
        with:
          mode: ${{ github.event.act && 'act' || 'github' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CHANGELOG (GitHub only)
        if: ${{ !github.event.act && steps.psr_2.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.psr_2.outputs.tag }} CHANGELOG.md --clobber

  # Kodi jobs for Phase 2 (GitHub only)
  kodi-check-2:
    needs: [release-phase-2]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - id: check
        uses: ./.github/actions/consolidated-kodi-check

  kodi-zip-2:
    needs: [release-phase-2, kodi-check-2]
    if: ${{ needs.kodi-check-2.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-2.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-2.outputs.kodi_directory }}
          version: ${{ needs.release-phase-2.outputs.version }}
          phase: 'phase-2'

  kodi-publish-2:
    needs: [release-phase-2, kodi-check-2, kodi-zip-2]
    if: ${{ needs.kodi-check-2.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-publish
        with:
          kodi_project_name: ${{ needs.kodi-check-2.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-2.outputs.version }}
          tag: ${{ needs.release-phase-2.outputs.tag }}
          phase: 'phase-2'

  kodi-publish-2-stub:
    needs: [release-phase-2]
    if: ${{ github.event.act }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Skipping Kodi jobs in ACT mode"

  # Phase 3: v1.0.0 (force major)
  release-phase-3:
    needs: [kodi-publish-2, kodi-publish-2-stub]
    if: always() && (needs.kodi-publish-2.result == 'success' || github.event.act)
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_3.outputs.tag }}
      version: ${{ steps.psr_3.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Generate commits (Phase 3)
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '3'
          branch: ci/${{ github.event.client_payload.run_id }}

      - name: Run psr_prepare (Phase 3)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare

      - name: Run PSR (Phase 3)
        id: psr_3
        uses: ./.github/actions/run-psr
        with:
          mode: ${{ github.event.act && 'act' || 'github' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: major

      - name: Upload CHANGELOG (GitHub only)
        if: ${{ !github.event.act && steps.psr_3.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.psr_3.outputs.tag }} CHANGELOG.md --clobber

  # Kodi jobs Phase 3 (GitHub only)
  kodi-check-3:
    needs: [release-phase-3]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - id: check
        uses: ./.github/actions/consolidated-kodi-check

  kodi-zip-3:
    needs: [release-phase-3, kodi-check-3]
    if: ${{ needs.kodi-check-3.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-3.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-3.outputs.kodi_directory }}
          version: ${{ needs.release-phase-3.outputs.version }}
          phase: 'phase-3'

  kodi-publish-3:
    needs: [release-phase-3, kodi-check-3, kodi-zip-3]
    if: ${{ needs.kodi-check-3.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-publish
        with:
          kodi_project_name: ${{ needs.kodi-check-3.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-3.outputs.version }}
          tag: ${{ needs.release-phase-3.outputs.tag }}
          phase: 'phase-3'

  # Phase 4: v1.0.0 (docs only)
  release-phase-4:
    needs: [kodi-publish-3]
    if: always() && needs.kodi-publish-3.result == 'success'
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_4.outputs.tag }}
      version: ${{ steps.psr_4.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Generate commits (Phase 4)
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '4'
          branch: ci/${{ github.event.client_payload.run_id }}

      - name: Run psr_prepare (Phase 4)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare

      - name: Run PSR (Phase 4)
        id: psr_4
        uses: ./.github/actions/run-psr
        with:
          mode: ${{ github.event.act && 'act' || 'github' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CHANGELOG (GitHub only)
        if: ${{ !github.event.act && steps.psr_4.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.psr_4.outputs.tag }} CHANGELOG.md --clobber

  # Phase 5: v1.0.1
  release-phase-5:
    needs: [release-phase-4]
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    outputs:
      tag: ${{ steps.psr_5.outputs.tag }}
      version: ${{ steps.psr_5.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Generate commits (Phase 5)
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '5'
          branch: ci/${{ github.event.client_payload.run_id }}

      - name: Run psr_prepare (Phase 5)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare

      - name: Run PSR (Phase 5)
        id: psr_5
        uses: ./.github/actions/run-psr
        with:
          mode: ${{ github.event.act && 'act' || 'github' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CHANGELOG (GitHub only)
        if: ${{ !github.event.act && steps.psr_5.outputs.tag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ steps.psr_5.outputs.tag }} CHANGELOG.md --clobber

  # Kodi jobs Phase 4 (GitHub only)
  kodi-check-4:
    needs: [release-phase-4]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - id: check
        uses: ./.github/actions/consolidated-kodi-check

  kodi-zip-4:
    needs: [release-phase-4, kodi-check-4]
    if: ${{ needs.kodi-check-4.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-4.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-4.outputs.kodi_directory }}
          version: ${{ needs.release-phase-4.outputs.version }}
          phase: 'phase-4'

  kodi-publish-4:
    needs: [release-phase-4, kodi-check-4, kodi-zip-4]
    if: ${{ needs.kodi-check-4.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-publish
        with:
          kodi_project_name: ${{ needs.kodi-check-4.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-4.outputs.version }}
          tag: ${{ needs.release-phase-4.outputs.tag }}
          phase: 'phase-4'

  # Kodi jobs Phase 5 (GitHub only)
  kodi-check-5:
    needs: [release-phase-5]
    runs-on: ubuntu-latest
    outputs:
      is_kodi: ${{ steps.check.outputs.is_kodi }}
      kodi_project_name: ${{ steps.check.outputs.kodi_project_name }}
      kodi_directory: ${{ steps.check.outputs.kodi_directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - id: check
        uses: ./.github/actions/consolidated-kodi-check

  kodi-zip-5:
    needs: [release-phase-5, kodi-check-5]
    if: ${{ needs.kodi-check-5.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-zip
        with:
          kodi_project_name: ${{ needs.kodi-check-5.outputs.kodi_project_name }}
          kodi_directory: ${{ needs.kodi-check-5.outputs.kodi_directory }}
          version: ${{ needs.release-phase-5.outputs.version }}
          phase: 'phase-5'

  kodi-publish-5:
    needs: [release-phase-5, kodi-check-5, kodi-zip-5]
    if: ${{ needs.kodi-check-5.outputs.is_kodi == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0
      - uses: ./.github/actions/consolidated-kodi-publish
        with:
          kodi_project_name: ${{ needs.kodi-check-5.outputs.kodi_project_name }}
          version: ${{ needs.release-phase-5.outputs.version }}
          tag: ${{ needs.release-phase-5.outputs.tag }}
          phase: 'phase-5'

  # Post-release tests (both modes)
  post-release-tests:
    needs: [kodi-publish-5]
    if: always()
    runs-on: ubuntu-latest
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: ${{ github.event.act && '0' || '1' }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ci/${{ github.event.client_payload.run_id }}
          fetch-depth: 0

      - name: Install uv
        uses: ./.github/actions/install-uv

      - name: Set up venv
        uses: ./.github/actions/setup-venv

      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies

      - name: Switch to test branch
        run: |
          git checkout ci/${{ github.event.client_payload.run_id }} || git checkout -b ci/${{ github.event.client_payload.run_id }}

      - name: Run post-PSR tests
        uses: ./.github/actions/run-post-psr-tests

      - name: Debug (ACT only)
        if: ${{ github.event.act }}
        run: |
          echo "=== Tags ===" && git tag -l
          echo "" && echo "=== Recent commits ===" && git --no-pager log --oneline -20
          echo "" && echo "=== Branches ===" && git branch -v
        continue-on-error: true

      - name: Cleanup (ACT only)
        if: ${{ always() && github.event.act }}
        run: |
          git checkout main || true
          git branch -D ci/${{ github.event.client_payload.run_id }} 2>/dev/null || true
          git tag -d $(git tag) 2>/dev/null || true
