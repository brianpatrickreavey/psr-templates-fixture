name: PSR Template Test Harness (ACT)

on:
  repository_dispatch:
    types: [test-harness-run]

jobs:
  test-harness-act:
    if: ${{ !startsWith(github.event.client_payload.run_id, 'gha-') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: kodi-addon-fixture
    env:
      UV_VENV: /tmp/venv
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Create test branch
        uses: ./.github/actions/create-test-branch
      - name: Install dev dependencies
        working-directory: ${{ github.workspace }}
        run: |
          source /tmp/venv/bin/activate
          uv pip install git+https://github.com/brianpatrickreavey/psr-templates.git pytest
      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests
      - name: Run arranger
        uses: ./.github/actions/run-arranger
      - name: Generate test commits
        uses: ./.github/actions/run-generate-commits
      - name: Check for Kodi project and set env vars
        id: check
        working-directory: kodi-addon-fixture
        run: |
          python ../tools/check_kodi.py ../pyproject.toml >> $GITHUB_OUTPUT
      - name: Pre-cleanup check (dry-run simulation)
        run: |
          echo "Simulated tags:" && git tag || echo "No tags"
          echo "Simulated releases:" && echo "None (dry-run)"
      - name: Run PSR dry-run
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Run post-PSR integration tests
        uses: ./.github/actions/run-post-psr-tests