name: PSR Template Test Harness (ACT)

on:
  repository_dispatch:
    types: [test-harness-run]

jobs:
  test-harness-act:
    if: ${{ !startsWith(github.event.client_payload.run_id, 'gha-') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: 0
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
      - name: Pre-cleanup local tags
        run: git tag -d $(git tag) || true
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Diagnostic - Test git remote operations
        run: |
          echo "=== Testing git remote-https functionality ==="
          git --version
          echo "=== Attempting to fetch psr-templates commit ==="
          cd /tmp && rm -rf test-git-fetch && mkdir test-git-fetch && cd test-git-fetch
          git init
          git fetch --force --update-head-ok 'https://github.com/brianpatrickreavey/psr-templates.git' '+106e3378c5f9b6733afe43886330e7ac9abc19b4:refs/commit/106e3378c5f9b6733afe43886330e7ac9abc19b4' 2>&1
          echo "Git fetch exit code: $?"
        shell: bash
      - name: Create test branch
        uses: ./.github/actions/create-test-branch
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies
      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests
      - name: Run arranger
        uses: ./.github/actions/run-arranger
      - name: Generate test commits
        uses: ./.github/actions/run-generate-commits
      - name: Check for Kodi project and set env vars
        id: check
        uses: ./.github/actions/check-kodi-project
      - name: Pre-cleanup check (dry-run simulation)
        run: |
          echo "Simulated tags:" && git tag || echo "No tags"
          echo "Simulated releases:" && echo "None (dry-run)"
      - name: Run PSR dry-run
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Run post-PSR integration tests
        uses: ./.github/actions/run-post-psr-tests
      - name: Clean up test branch
        if: always()
        run: |
          git checkout main || true
          git branch -D ci/${{ github.event.client_payload.run_id }} 2>/dev/null || true
      - name: Final cleanup local tags
        if: always()
        run: git tag -d $(git tag) || true