name: PSR Template Test Harness (ACT)

on:
  repository_dispatch:
    types: [test-harness-run]

permissions:
  contents: write

concurrency:
  group: psr-test-harness-act-${{ github.repository }}
  cancel-in-progress: false

jobs:
  test-harness-act:
    if: ${{ !startsWith(github.event.client_payload.run_id, 'gha-') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    env:
      UV_VENV: /tmp/venv
      PSR_VALIDATE_REAL: 0
    steps:
      - name: Checkout fixture repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: brianpatrickreavey/psr-templates-fixture
      - name: Pre-cleanup local tags and releases
        run: git tag -d $(git tag) 2>/dev/null || true
      - name: Install uv
        uses: ./.github/actions/install-uv
      - name: Set up venv
        uses: ./.github/actions/setup-venv
      - name: Create test branch
        uses: ./.github/actions/create-test-branch
      - name: Install dev dependencies
        uses: ./.github/actions/install-dev-dependencies
      - name: Run pre-PSR integration tests
        uses: ./.github/actions/run-pre-psr-tests

      # Phase 1: 0.1.0
      - name: Generate and push phase 1 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '1'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 1)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 0.1.0)
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Build Kodi addon ZIP (Phase 1 - v0.1.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: script.module.example
          kodi_directory: script.module.example
          version: 0.1.0
          phase: phase-1
      - name: Upload rendered templates (Phase 1 - v0.1.0)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-templates-phase-1-v0.1.0
          path: |
            CHANGELOG.md
            script.module.example/addon.xml
          retention-days: 5

      # Phase 2: 0.2.0
      - name: Generate and push phase 2 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '2'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Debug - Dump addon.xml before Phase 2 psr_prepare
        run: |
          echo "=== addon.xml before Phase 2 psr_prepare ==="
          cat script.module.example/addon.xml
          echo ""
          echo "=== File size and type ==="
          wc -c script.module.example/addon.xml
          file script.module.example/addon.xml
          echo ""
          echo "=== Check for hidden chars at start (first 10 bytes as octal) ==="
          head -c 10 script.module.example/addon.xml | od -c
        continue-on-error: true
      - name: Run psr_prepare (Phase 2)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 0.2.0)
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Build Kodi addon ZIP (Phase 2 - v0.2.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: script.module.example
          kodi_directory: script.module.example
          version: 0.2.0
          phase: phase-2
      - name: Upload rendered templates (Phase 2 - v0.2.0)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-templates-phase-2-v0.2.0
          path: |
            CHANGELOG.md
            script.module.example/addon.xml
          retention-days: 5

      # Phase 3: 1.0.0 (force major)
      - name: Generate and push phase 3 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '3'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 3)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.0 - force major)
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
          force: 'major'
      - name: Build Kodi addon ZIP (Phase 3 - v1.0.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: script.module.example
          kodi_directory: script.module.example
          version: 1.0.0
          phase: phase-3
      - name: Upload rendered templates (Phase 3 - v1.0.0)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-templates-phase-3-v1.0.0
          path: |
            CHANGELOG.md
            script.module.example/addon.xml
          retention-days: 5

      # Phase 4: 1.0.0 (no version bump, documentation only)
      - name: Generate and push phase 4 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '4'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 4)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.0 - docs only)
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Build Kodi addon ZIP (Phase 4 - v1.0.0)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: script.module.example
          kodi_directory: script.module.example
          version: 1.0.0
          phase: phase-4
      - name: Upload rendered templates (Phase 4 - v1.0.0)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-templates-phase-4-v1.0.0
          path: |
            CHANGELOG.md
            script.module.example/addon.xml
          retention-days: 5

      # Phase 5: 1.0.1
      - name: Generate and push phase 5 commits
        uses: ./.github/actions/generate-and-push-commits
        with:
          phase: '5'
          branch: ci/${{ github.event.client_payload.run_id }}
      - name: Run psr_prepare (Phase 5)
        run: |
          source /tmp/venv/bin/activate
          psr-prepare
      - name: Run PSR (Release 1.0.1)
        uses: ./.github/actions/run-psr-locally
        with:
          fixture_dir: .
      - name: Build Kodi addon ZIP (Phase 5 - v1.0.1)
        uses: ./.github/actions/build-kodi-zip
        with:
          kodi_project_name: script.module.example
          kodi_directory: script.module.example
          version: 1.0.1
          phase: phase-5
      - name: Upload rendered templates (Phase 5 - v1.0.1)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-templates-phase-5-v1.0.1
          path: |
            CHANGELOG.md
            script.module.example/addon.xml
          retention-days: 5

      - name: Run post-PSR integration tests
        uses: ./.github/actions/run-post-psr-tests
      - name: Debug - List tags and recent commits before cleanup
        run: |
          echo "=== Git tags ==="
          git tag -l
          echo ""
          echo "=== Recent 20 commits ==="
          git --no-pager log --oneline -20
          echo ""
          echo "=== Current branch ==="
          git branch -v
        continue-on-error: true
      - name: Clean up test branch
        if: always()
        run: |
          git checkout main || true
          git branch -D ci/${{ github.event.client_payload.run_id }} 2>/dev/null || true
      - name: Final cleanup local tags
        if: always()
        run: git tag -d $(git tag) 2>/dev/null || true